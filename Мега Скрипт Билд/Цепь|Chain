/**
 * Auto Chain Addon - Rapidly places bombs when activated
 * This addon properly integrates with the Game Bot Framework using the addon manager
 */

// Register the Auto Chain addon with the Game Bot Addon Manager
window.gameBotAddonManager.registerFeature('auto-chain', {
    label: 'Auto Chain (C)',  // Display name in UI
    initialActive: false,     // Start deactivated
    
    // Initialization function - called when the addon is registered
    initialize: function() {
        // Log initialization
        logActivity("Auto Chain addon initialized");
        
        // Create an interval for bomb spamming
        this.interval = setInterval(() => {
            // Only run if the addon is active
            if (!this.active) return;
            
            // Simulate K keypress (place bomb) as fast as possible
            simulateKeyDown(75); // K key
            
            // Flash UI feedback (much less frequently to avoid flickering)
            if (Math.random() < 0.02) { // Only flash for ~2% of bombs
                flashButtonStatus('auto-chain', '#FFD700');
            }
            
            // Release K key immediately for rapid spam
            setTimeout(() => {
                simulateKeyUp(75); // K key
            }, 10);
        }, 20); // 20ms interval for very fast bomb spam
    },
    
    // Cleanup function - called when the addon is disabled or page unloads
    cleanup: function() {
        // Clear the interval to stop bomb spamming
        if (this.interval) {
            clearInterval(this.interval);
            this.interval = null;
        }
        // Make sure we're marked as inactive
        this.active = false;
        updateStatus('auto-chain', false);
    },
    
    // Key down handler - toggle on when C key is pressed
    onKeyDown: function(event) {
        // Toggle auto chain when C is pressed
        if (event.key && event.key.toLowerCase() === 'c') {
            this.active = true;
            updateStatus('auto-chain', true);
            logActivity("Auto Chain activated");
        }
    },
    
    // Key up handler - toggle off when C key is released
    onKeyUp: function(event) {
        // Turn off auto chain when C is released
        if (event.key && event.key.toLowerCase() === 'c') {
            this.active = false;
            updateStatus('auto-chain', false);
            logActivity("Auto Chain deactivated");
        }
    }
});

// Export module functions for use in console
window.autoChainAddon = {
    // Toggle the addon on/off
    toggle: function() {
        const addon = window.gameBotAddonManager.features['auto-chain'];
        if (addon) {
            addon.active = !addon.active;
            updateStatus('auto-chain', addon.active);
            logActivity(`Auto Chain ${addon.active ? 'activated' : 'deactivated'}`);
        }
    },
    
    // Check if the addon is active
    isActive: function() {
        const addon = window.gameBotAddonManager.features['auto-chain'];
        return addon ? addon.active : false;
    },
    
    // Cleanup function
    cleanup: function() {
        const addon = window.gameBotAddonManager.features['auto-chain'];
        if (addon && typeof addon.cleanup === 'function') {
            addon.cleanup();
        }
    }
};
