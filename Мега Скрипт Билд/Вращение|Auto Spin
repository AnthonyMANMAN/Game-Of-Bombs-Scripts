// Rotation Addon for Game Bot Framework
// This addon adds rotation functionality to the base bot framework

// Create module-level variables outside the addon object to solve 'this' context issues
let rotationAddon_inProgress = false;
let rotationAddon_interval = null;
let rotationAddon_active = false;

// Remove all visual indicator related functions and calls
function rotationAddon_performRotation() {
    if (!rotationAddon_active) return;
    
    // Only start if not already in progress
    if (rotationAddon_inProgress) return;
    
    rotationAddon_inProgress = true;
    
    let currentStep = 0;
    // W(up), A(left), S(down), D(right), S(down), A(left) translated to arrow key codes
    const sequenceKeys = [38, 37, 40, 39, 40, 37];
    
    rotationAddon_interval = setInterval(() => {
        // Use the framework's key simulation functions
        simulateKeyDown(sequenceKeys[currentStep]);
        
        setTimeout(() => {
            simulateKeyUp(sequenceKeys[currentStep]);
            currentStep = (currentStep + 1) % 6; // Cycle through all 6 steps
        }, 5);
    }, 100);
}

function rotationAddon_stopRotation() {
    if (rotationAddon_interval) {
        clearInterval(rotationAddon_interval);
        rotationAddon_interval = null;
    }
    
    rotationAddon_inProgress = false;
    
    // Release all arrow keys if they're being held
    [37, 38, 39, 40].forEach(keyCode => {
        simulateKeyUp(keyCode);
    });
}

// Register the rotation addon with the bot framework
window.gameBotAddonManager.registerFeature('rotationAddon', {
    label: 'Режим Вращения(N)',
    initialActive: false,
    
    // Initialize the addon
    initialize: function() {
        // Add visualization for rotation state in the main UI
        logActivity("Rotation addon initialized - use 'N' key to toggle");
        
        // Set the initial active state
        rotationAddon_active = this.active;
        
        // Initial UI status update
        updateStatus('rotationAddon', this.active);
    },
    
    // Cleanup when the addon is disabled
    cleanup: function() {
        // Clear any ongoing rotation
        rotationAddon_stopRotation();
        
        logActivity("Rotation addon cleanup complete");
    },
    
    // Handle keydown events
    onKeyDown: function(event) {
        const key = event.key.toLowerCase();
        // Toggle rotation mode with N key
        if (key === 'n') {
            this.active = !this.active;
            rotationAddon_active = this.active;
            updateStatus('rotationAddon', this.active);
            
            // Start or stop rotation based on active state
            if (rotationAddon_active) {
                rotationAddon_performRotation();
                logActivity("Rotation mode activated - continuous rotation until toggled off");
            } else {
                rotationAddon_stopRotation();
                logActivity("Rotation mode deactivated");
            }
        }
    },
    
    // Placeholder for onKeyUp - not used in this addon but required by framework
    onKeyUp: function(event) {
        // No special handling needed for keyup events
    }
});

// Log that the addon was loaded
logActivity("Rotation addon loaded - Press 'N' to toggle continuous rotation mode");
