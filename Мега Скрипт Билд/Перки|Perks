// Spam Key Rotation Addon
// This addon automatically cycles keys 1-4 repeatedly when toggled on by pressing B

(function() {
    // State variables for the spam feature
    let spamActive = false;
    let spamInterval = null;
    const SPAM_DELAY = 50; // ms between key presses
    const SPAM_KEYS = [49, 50, 51, 52]; // Key codes for 1, 2, 3, 4

    // Simulate key press (keydown + keyup)
    function simulateKeyPress(keyCode) {
        document.dispatchEvent(new KeyboardEvent("keydown", { keyCode: keyCode }));
        document.dispatchEvent(new KeyboardEvent("keyup", { keyCode: keyCode }));
    }

    // Start spamming keys 1-4
    function startSpamming() {
        let index = 0;
        spamInterval = setInterval(() => {
            simulateKeyPress(SPAM_KEYS[index]);
            index = (index + 1) % SPAM_KEYS.length;
        }, SPAM_DELAY);
        logActivity("Spam mode activated - cycling keys 1-4");
    }

    // Stop spamming keys
    function stopSpamming() {
        if (spamInterval) {
            clearInterval(spamInterval);
            spamInterval = null;
            logActivity("Spam mode deactivated");
        }
    }

    // Create UI elements for spam feature
    function createSpamUI() {
        const botUiContainer = document.getElementById('bot-ui-container');
        if (!botUiContainer) {
            console.log("Main bot UI not found. Spam UI will retry in 1 second.");
            setTimeout(createSpamUI, 1000);
            return;
        }

        // Remove existing spam controls if any (avoid duplicates)
        const existingControl = document.getElementById('spam-status');
        if (existingControl && existingControl.parentElement) {
            existingControl.parentElement.remove();
        }

        // Container for the spam status
        const spamContainer = document.createElement('div');
        spamContainer.style.cssText = `
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            align-items: center;
        `;

        // Label for the toggle info
        const spamLabel = document.createElement('span');
        spamLabel.textContent = 'Спам Перками (B)';

        // Status indicator with color and background
        const spamStatus = document.createElement('span');
        spamStatus.id = 'spam-status';
        spamStatus.textContent = spamActive ? 'ON' : 'OFF';
        spamStatus.style.cssText = `
            font-weight: bold;
            color: ${spamActive ? '#4CAF50' : '#F44336'};
            background-color: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
        `;

        spamContainer.appendChild(spamLabel);
        spamContainer.appendChild(spamStatus);

        // Insert after the first control or append if none
        const firstControl = botUiContainer.querySelector('div > div:not(:first-child)');
        if (firstControl) {
            firstControl.insertAdjacentElement('afterend', spamContainer);
        } else {
            botUiContainer.appendChild(spamContainer);
        }

        if (typeof logActivity === 'function') {
            logActivity("Spam Key Rotation UI added");
        } else {
            console.log("Spam Key Rotation UI added");
        }
    }

    // Update UI status text and colors
    function updateSpamStatus() {
        const statusEl = document.getElementById('spam-status');
        if (!statusEl) return;
        statusEl.textContent = spamActive ? 'ON' : 'OFF';
        statusEl.style.color = spamActive ? '#4CAF50' : '#F44336';
    }

    // Toggle spam mode on B key press
    function handleSpamToggle(event) {
        if (event.key.toLowerCase() === 'b') {
            spamActive = !spamActive;
            updateSpamStatus();

            if (typeof logActivity === 'function') {
                logActivity(`Spam Key Rotation ${spamActive ? 'enabled' : 'disabled'}`);
            } else {
                console.log(`Spam Key Rotation ${spamActive ? 'enabled' : 'disabled'}`);
            }

            if (spamActive) {
                startSpamming();
            } else {
                stopSpamming();
            }
        }
    }

    // Initialize UI and event listener
    function initialize() {
        createSpamUI();
        updateSpamStatus();
        document.addEventListener("keydown", handleSpamToggle);
    }

    // Cleanup function (optional)
    function cleanup() {
        document.removeEventListener("keydown", handleSpamToggle);
        stopSpamming();
        updateSpamStatus();
    }

    // If your bot uses a registerFeature pattern, register here
    if (window.gameBotAddonManager && typeof window.gameBotAddonManager.registerFeature === 'function') {
        window.gameBotAddonManager.registerFeature('spam-feature', {
            label: 'Спам Перками (B)',
            initialActive: false,
            initialize: initialize,
            cleanup: cleanup
        });
    } else {
        // Otherwise just initialize right away
        initialize();
    }

    // Optional: cleanup on page unload
    window.addEventListener('beforeunload', cleanup);

})();
